#!/bin/bash -p

PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
CHALLPATH=`pwd`

STTY=$(stty -g)
stty intr ^-

TEMP=$(mktemp -d -p /var/tmp/)
chgrp `whoami` ${TEMP}
chmod 770 ${TEMP}

echo ""
echo "A share will be available: host:${TEMP} -> guest:/mnt/share"
echo "Launching the vulnerable machine..."
echo ""

sleep 5

qemu-system-x86_64 \
        -m 128M \
        -cpu kvm64 \
        -nographic \
        -kernel $CHALLPATH/bzImage \
        -machine pc,accel=kvm \
        -append 'console=ttyS0 loglevel=3 oops=panic panic=1 kaslr' \
        -monitor /dev/null \
        -enable-kvm \
        -initrd $CHALLPATH/initramfs.cpio.gz \
        -drive file=$CHALLPATH/passwd.img,if=virtio \
        -snapshot \
        -fsdev local,id=exp1,path=${TEMP},security_model=mapped -device virtio-9p-pci,fsdev=exp1,mount_tag=shared \
        -no-reboot

rm -rf "${TEMP}" 2> /dev/null
stty "${STTY}"

